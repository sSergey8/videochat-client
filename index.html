<!DOCTYPE html> // –í–µ—Ä—Å–∏—è 1.2.1
<html>
<head>
<meta charset="UTF-8">
<title>P2P Video Chat</title>
<style>
    video { width: 45%; margin: 5px; background: black; }
</style>
</head>
<body>

<h2>P2P Video Chat</h2>
<video id="localVideo" autoplay muted playsinline></video>
<video id="remoteVideo" autoplay playsinline></video>

<script>
// üîó –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ô WSS URL
const signalingUrl = "wss://webrtc-signaling-server-9su4.onrender.com";

// –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ signaling-—Å–µ—Ä–≤–µ—Ä—É
const socket = new WebSocket(signalingUrl);

let pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
});

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
pc.onicecandidate = event => {
    if (event.candidate) {
        socket.send(JSON.stringify({ type: "candidate", candidate: event.candidate }));
    }
};

// –ø–æ–ª—É—á–∞–µ–º remote stream
pc.ontrack = event => {
    document.getElementById("remoteVideo").srcObject = event.streams[0];
};

// –∂–¥–µ–º —Å–æ–∫–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
socket.onopen = async () => {
    console.log("WebSocket connected");
};

// –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π signaling
socket.onmessage = async msg => {
    const data = JSON.parse(msg.data);

    if (data.type === "offer") {
        await pc.setRemoteDescription(data.offer);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        socket.send(JSON.stringify({ type: "answer", answer }));
    }

    if (data.type === "answer") {
        await pc.setRemoteDescription(data.answer);
    }

    if (data.type === "candidate") {
        try {
            await pc.addIceCandidate(data.candidate);
        } catch (e) {
            console.error("Error adding ICE", e);
        }
    }
};

// üé• –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É –∏ –ú–ò–ö–†–û–§–û–ù
navigator.mediaDevices.getUserMedia({ video: true, audio: true })
    .then(async stream => {
        const localVideo = document.getElementById("localVideo");
        localVideo.srcObject = stream;

        stream.getTracks().forEach(track => pc.addTrack(track, stream));

        // —Ç–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞—ë–º offer –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–æ–≤
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        socket.send(JSON.stringify({ type: "offer", offer }));

    }).catch(err => {
        console.error("Media error:", err);
    });
</script>
</body>
</html>
