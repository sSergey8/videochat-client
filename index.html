// Версия 1.3.4
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>P2P Video Chat</title>
<style>
    video {
        width: 45%;
        margin: 5px;
        background: black;
    }
</style>
</head>
<body>

<h2>P2P Video Chat</h2>
<video id="localVideo" autoplay muted playsinline></video>
<video id="remoteVideo" autoplay playsinline></video>

<script>

// === SETTINGS ===
const signalingUrl = "wss://webrtc-signaling-server-9su4.onrender.com";
const room = "default-room";

// --- WebSocket ---
const socket = new WebSocket(signalingUrl);

let socketReady = false;
let isOfferer = false;

// --- WebRTC ---
let pc = new RTCPeerConnection({
    iceServers: [
        { urls: "stun:global.stun.twilio.com:3478" },
        {
            urls: "turn:global.turn.twilio.com:3478?transport=udp",
            username: "a545c6e4621b2ba9b810a161b377f49160772ee0ff06f390d4b2d297069767bb",
            credential: "GshgV48ou2Qjoicwe/jM2TNGx16DvDH5zPBSi7/hZv8="
        },
        {
            urls: "turn:global.turn.twilio.com:3478?transport=tcp",
            username: "a545c6e4621b2ba9b810a161b377f49160772ee0ff06f390d4b2d297069767bb",
            credential: "GshgV48ou2Qjoicwe/jM2TNGx16DvDH5zPBSi7/hZv8="
        },
        {
            urls: "turn:global.turn.twilio.com:443?transport=tcp",
            username: "a545c6e4621b2ba9b810a161b377f49160772ee0ff06f390d4b2d297069767bb",
            credential: "GshgV48ou2Qjoicwe/jM2TNGx16DvDH5zPBSi7/hZv8="
        }
    ]
});

// --- Peer events ---
pc.onicecandidate = event => {
    if (event.candidate) {
        socket.send(JSON.stringify({ type: "candidate", candidate: event.candidate }));
    }
};

pc.ontrack = event => {
    document.getElementById("remoteVideo").srcObject = event.streams[0];
};

// --- WebSocket events ---
socket.onopen = () => {
    socketReady = true;
    socket.send(JSON.stringify({ type: "join", room }));
};

socket.onmessage = async msg => {
    const data = JSON.parse(msg.data);

    if (data.type === "joined") {
        // server сообщает сколько клиентов в комнате
        if (data.count === 1) {
            isOfferer = true;    // первый → делает offer
        } else {
            isOfferer = false;   // второй → ждет offer
        }
    }

    if (data.type === "offer") {
        await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        socket.send(JSON.stringify({ type: "answer", answer }));
    }

    if (data.type === "answer") {
        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
    }

    if (data.type === "candidate") {
        try {
            await pc.addIceCandidate(data.candidate);
        } catch {}
    }
};

// --- Media ---
navigator.mediaDevices.getUserMedia({ video: true, audio: true })
    .then(async stream => {
        document.getElementById("localVideo").srcObject = stream;
        stream.getTracks().forEach(t => pc.addTrack(t, stream));

        // создаем offer только если мы offerer
        const wait = () => {
            if (!socketReady) return setTimeout(wait, 100);
            if (isOfferer) createOffer();
        };

        wait();
    });

async function createOffer() {
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.send(JSON.stringify({ type: "offer", offer }));
}

</script>
</body>
</html>
