// –í–µ—Ä—Å–∏—è 1.2.3
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>P2P Video Chat</title>
<style>
    video {
        width: 45%;
        margin: 5px;
        background: black;
    }
</style>
</head>
<body>

<h2>P2P Video Chat</h2>
<video id="localVideo" autoplay muted playsinline></video>
<video id="remoteVideo" autoplay playsinline></video>

<script>
// üîó –¢–≤–æ–π signaling server
const signalingUrl = "wss://webrtc-signaling-server-9su4.onrender.com";

// üî• –ö–æ–º–Ω–∞—Ç–∞ (–æ–¥–∏–Ω–∞–∫–æ–≤–∞—è —É –¥–≤—É—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
const ROOM = "room123";

const socket = new WebSocket(signalingUrl);

let pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
});

// –û—Ç–ø—Ä–∞–≤–∫–∞ ICE
pc.onicecandidate = event => {
    if (event.candidate) {
        socket.send(JSON.stringify({
            type: "candidate",
            room: ROOM,
            candidate: event.candidate
        }));
    }
};

// –ü–æ–ª—É—á–µ–Ω–∏–µ remote –ø–æ—Ç–æ–∫–∞
pc.ontrack = event => {
    document.getElementById("remoteVideo").srcObject = event.streams[0];
};

// üî• –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ Blob ‚Üí JSON)
socket.onmessage = async msg => {

    let text;
    if (msg.data instanceof Blob) {
        text = await msg.data.text();
    } else {
        text = msg.data;
    }

    let data;
    try {
        data = JSON.parse(text);
    } catch (e) {
        console.warn("–ü—Ä–æ–ø—É—Å–∫–∞—é –Ω–µ-JSON —Å–æ–æ–±—â–µ–Ω–∏–µ:", text);
        return;
    }

    if (data.type === "offer") {
        await pc.setRemoteDescription(data.offer);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        socket.send(JSON.stringify({
            type: "answer",
            room: ROOM,
            answer
        }));
    }

    if (data.type === "answer") {
        await pc.setRemoteDescription(data.answer);
    }

    if (data.type === "candidate") {
        await pc.addIceCandidate(data.candidate);
    }
};

// üî• –ü–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WebSocket ‚Üí –≤—Ö–æ–¥–∏–º –≤ –∫–æ–º–Ω–∞—Ç—É
socket.onopen = () => {
    socket.send(JSON.stringify({
        type: "join",
        room: ROOM
    }));
};

// üé• –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≤–∏–¥–µ–æ + –∞—É–¥–∏–æ
navigator.mediaDevices.getUserMedia({ video: true, audio: true })
    .then(async stream => {
        document.getElementById("localVideo").srcObject = stream;

        stream.getTracks().forEach(track => pc.addTrack(track, stream));

        // –°–æ–∑–¥–∞–µ–º offer –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–æ–≤
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        socket.send(JSON.stringify({
            type: "offer",
            room: ROOM,
            offer
        }));
    });
</script>
</body>
</html>
