// –í–µ—Ä—Å–∏—è 1.2.2
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>P2P Video Chat</title>
<style>
    video { width: 45%; margin: 5px; background: black; }
</style>
</head>
<body>

<h2>P2P Video Chat</h2>
<video id="localVideo" autoplay muted playsinline></video>
<video id="remoteVideo" autoplay playsinline></video>

<script>
const signalingUrl = "wss://webrtc-signaling-server-9su4.onrender.com";
const ROOM = "room123"; // üî• –æ–¥–∏–Ω–∞–∫–æ–≤–æ —É –≤—Å–µ—Ö

const socket = new WebSocket(signalingUrl);

let pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
});

pc.onicecandidate = event => {
    if (event.candidate) {
        socket.send(JSON.stringify({
            type: "candidate",
            candidate: event.candidate
        }));
    }
};

pc.ontrack = event => {
    document.getElementById("remoteVideo").srcObject = event.streams[0];
};

socket.onopen = () => {
    console.log("WS connected");

    // üî• –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û ‚Äì –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
    socket.send(JSON.stringify({
        type: "join",
        room: ROOM
    }));
};

socket.onmessage = async msg => {
    const data = JSON.parse(msg.data);

    if (data.type === "offer") {
        await pc.setRemoteDescription(data.offer);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        socket.send(JSON.stringify({ type: "answer", answer }));
    }

    if (data.type === "answer") {
        await pc.setRemoteDescription(data.answer);
    }

    if (data.type === "candidate") {
        await pc.addIceCandidate(data.candidate);
    }
};

navigator.mediaDevices.getUserMedia({ video: true, audio: true })
    .then(async stream => {
        document.getElementById("localVideo").srcObject = stream;

        stream.getTracks().forEach(track => pc.addTrack(track, stream));

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        socket.send(JSON.stringify({ type: "offer", offer }));
    });
</script>
</body>
</html>
