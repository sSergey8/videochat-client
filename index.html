// Версия 1.3.6
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>P2P Video Chat</title>
<style>
    video {
        width: 45%;
        margin: 5px;
        background: black;
    }
</style>
</head>
<body>

<h2>P2P Video Chat</h2>
<video id="localVideo" autoplay muted playsinline></video>
<video id="remoteVideo" autoplay playsinline></video>

<script>
// ---------------- SETTINGS ----------------
const signalingUrl = "wss://webrtc-signaling-server-9su4.onrender.com";
const room = "default-room";

// Twilio TURN
const iceServers = [
    { urls: "stun:global.stun.twilio.com:3478" },
    {
        urls: "turn:global.turn.twilio.com:3478?transport=udp",
        username: "a545c6e4621b2ba9b810a161b377f49160772ee0ff06f390d4b2d297069767bb",
        credential: "GshgV48ou2Qjoicwe/jM2TNGx16DvDH5zPBSi7/hZv8="
    },
    {
        urls: "turn:global.turn.twilio.com:3478?transport=tcp",
        username: "a545c6e4621b2ba9b810a161b377f49160772ee0ff06f390d4b2d297069767bb",
        credential: "GshgV48ou2Qjoicwe/jM2TNGx16DvDH5zPBSi7/hZv8="
    },
    {
        urls: "turn:global.turn.twilio.com:443?transport=tcp",
        username: "a545c6e4621b2ba9b810a161b377f49160772ee0ff06f390d4b2d297069767bb",
        credential: "GshgV48ou2Qjoicwe/jM2TNGx16DvDH5zPBSi7/hZv8="
    }
];


// ---------------- SIGNALING (WS) ----------------
const socket = new WebSocket(signalingUrl);
let socketReady = false;
let messageQueue = [];

function wsSend(data) {
    if (!socketReady) {
        messageQueue.push(data);
        return;
    }
    socket.send(JSON.stringify(data));
}

socket.onopen = () => {
    socketReady = true;
    wsSend({ type: "join", room });

    messageQueue.forEach(msg => socket.send(JSON.stringify(msg)));
    messageQueue = [];
};

// ---------------- WEBRTC ----------------
let pc = new RTCPeerConnection({ iceServers });

pc.onicecandidate = e => {
    if (e.candidate) {
        wsSend({ type: "candidate", candidate: e.candidate });
    }
};

pc.ontrack = e => {
    console.log("REMOTE STREAM");
    document.getElementById("remoteVideo").srcObject = e.streams[0];
};

// ---------------- STATE FLAGS ----------------
let localStream = null;
let localStreamReady = false;
let joinInfo = null;


// ---------------- HANDLE INCOMING SIGNALING ----------------
socket.onmessage = async msg => {
    const data = JSON.parse(msg.data);

    if (data.type === "joined") {
        joinInfo = data;
        console.log("Joined room. Users:", joinInfo.count);
        tryCreateOffer();
        return;
    }

    if (data.type === "offer") {
        console.log("Received OFFER");

        await pc.setRemoteDescription(data.offer);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        wsSend({ type: "answer", answer });
        return;
    }

    if (data.type === "answer") {
        console.log("Received ANSWER");
        await pc.setRemoteDescription(data.answer);
        return;
    }

    if (data.type === "candidate") {
        try {
            await pc.addIceCandidate(data.candidate);
        } catch (err) {
            console.error("ICE error", err);
        }
        return;
    }
};


// ---------------- CAMERA ----------------
navigator.mediaDevices.getUserMedia({ video: true, audio: true })
    .then(stream => {
        localStream = stream;
        localStreamReady = true;

        document.getElementById("localVideo").srcObject = stream;
        stream.getTracks().forEach(t => pc.addTrack(t, stream));

        tryCreateOffer();
    })
    .catch(err => console.error("Camera/microphone error:", err));


// ---------------- OFFER CREATION LOGIC ----------------
async function tryCreateOffer() {
    if (!socketReady || !localStreamReady || !joinInfo) return;

    // Only FIRST user (count=1) creates offer
    if (joinInfo.count === 1) {
        console.log("Creating OFFER");
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        wsSend({ type: "offer", offer });
    } else {
        console.log("Second user → waiting for offer");
    }
}

</script>
</body>
</html>
